<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport" />
    <meta content="物不可以穷也，故受之以未济" name="description" />
    <meta content="web development, programming, typeface, typography" name="keywords" />
    <meta content="karottc" name="author" />
    <link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" />
    <link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" />
    <link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" />
    <link href="/manifest.json" rel="manifest" />
    <link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon" />
    <meta content="#ffffff" name="theme-color" />
    <title>React-Native 播放 FMOD Studio 的 bank 音频</title>
    <link href="/static/dist/semantic-ui/semantic.min.css" rel="stylesheet" type="text/css" />
    <link href="/static/dist/fonts.css/fonts.css" rel="stylesheet" type="text/css" />
    <link href="/static/stylesheet/default.css" rel="stylesheet" type="text/css" />
    <link href="/static/stylesheet/pandoc-code-highlight.css" rel="stylesheet" type="text/css" />
    <script src="/static/dist/jquery/jquery.min.js"></script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
  </head>
  <body lang="cn">
    <div data-quotes-cn="[{&quot;content&quot;:[&quot;天上星，亮晶晶，永灿烂，长安宁。&quot;,&quot;湖边竹，盈盈绿，报平安，多喜乐。&quot;],&quot;author&quot;:&quot;金庸&quot;,&quot;from&quot;:&quot;天龙八部&quot;},{&quot;content&quot;:[&quot;死亡是唯一一座永远亮着的灯塔，不管你向哪里航行，最终都得转向它指引的方向。一切都会逝去，只有死神永生。&quot;],&quot;author&quot;:&quot;刘慈欣&quot;,&quot;from&quot;:&quot;地球往事&quot;},{&quot;content&quot;:[&quot;我终于明白了为什么 Einstein 喜爱看守灯塔的职业，因为那样他可以在自己的心灵中建立一片宁静而自由的天空。&quot;],&quot;author&quot;:&quot;卢昌海&quot;,&quot;from&quot;:&quot;&lt;a href=\&quot;http://www.changhai.org\&quot;&gt;http://www.changhai.org&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;我宁愿游荡在你身边&quot;,&quot;做七天的野鬼&quot;,&quot;跟随你&quot;,&quot;就算落进最黑暗的地方&quot;,&quot;我的爱&quot;,&quot;也不会让我成为永远的孤魂&quot;],&quot;author&quot;:&quot;李安&quot;,&quot;from&quot;:&quot;卧虎藏龙&quot;},{&quot;content&quot;:[&quot;在中国，任何超脱飞扬的思想都会砰然坠地——现实的引力实在是太沉重了。&quot;],&quot;author&quot;:&quot;刘慈欣&quot;,&quot;from&quot;:&quot;地球往事&quot;},{&quot;content&quot;:[&quot;天下唯庸人无咎无誉。&quot;],&quot;author&quot;:&quot;梁启超&quot;,&quot;from&quot;:&quot;李鸿章传&quot;},{&quot;content&quot;:[&quot;人生如小说，&quot;,&quot;相逢只一章。&quot;,&quot;其余无限字，&quot;,&quot;跌宕且彷徨。&quot;],&quot;author&quot;:&quot;贺金缕&quot;,&quot;from&quot;:&quot;空白集&quot;},{&quot;content&quot;:[&quot;姑妄言之姑听之，&quot;,&quot;豆棚瓜架雨如丝。&quot;],&quot;author&quot;:&quot;渔洋山人&quot;,&quot;from&quot;:&quot;聊斋志异-题辞&quot;},{&quot;content&quot;:[&quot;何日功成名遂了，&quot;,&quot;还乡，&quot;,&quot;醉笑陪公三万场。&quot;],&quot;author&quot;:&quot;苏轼&quot;,&quot;from&quot;:&quot;南乡子-和杨元素，时移守密州&quot;},{&quot;content&quot;:[&quot;守法朝朝忧闷，&quot;,&quot;强梁夜夜欢歌，&quot;,&quot;损人利己骑马骡，&quot;,&quot;正直公平挨饿；&quot;,&quot;修桥补路瞎眼，&quot;,&quot;杀人放火儿多，&quot;,&quot;伤心病狂好酒喝，&quot;,&quot;良善必遭横祸。&quot;],&quot;author&quot;:&quot;郭德纲&quot;,&quot;from&quot;:&quot;相声&quot;},{&quot;content&quot;:[&quot;登山一马当先，&quot;,&quot;岂敢假装少年。&quot;,&quot;只因恐怕落后，&quot;,&quot;所以拼命向前。&quot;],&quot;author&quot;:&quot;梁思成&quot;,&quot;from&quot;:&quot;随笔&quot;}]" data-quotes-en="[{&quot;content&quot;:[&quot;Pascal is for building pyramids—imposing, breathtaking, static structures built by armies pushing heavy blocks into place. Lisp is for building organisms—imposing, breathtaking, dynamic structures built by squads fitting fluctuating myriads of simpler organisms into place.&quot;],&quot;author&quot;:&quot;Alan J. Perlis&quot;,&quot;from&quot;:&quot;foreword for &lt;a href=\&quot;http://mitpress.mit.edu/sicp/\&quot;&gt;SICP&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;When you don&#39;t create things, you become defined by your tastes rather than ability. Your tastes only narrow &amp; exclude people. So create.&quot;],&quot;author&quot;:&quot;why the luck stiff&quot;,&quot;from&quot;:&quot;&lt;a href=\&quot;http://whymirror.github.io/\&quot;&gt;http://whymirror.github.io/&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;In theory, there is no difference between theory and practice. But, in practice, there is.&quot;],&quot;author&quot;:&quot;Jan L. A. van de Snepscheut&quot;,&quot;from&quot;:&quot;&lt;a href=\&quot;http://en.wikiquote.org/wiki/Jan_L._A._van_de_Snepscheut\&quot;&gt;Wikipedia&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;The future has already arrived. It is just not evenly distributed yet.&quot;],&quot;author&quot;:&quot;William Gibson&quot;,&quot;from&quot;:&quot;&lt;a href=\&quot;https://en.wikiquote.org/wiki/William_Gibson\&quot;&gt;Wikiquote&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;There are many ways of trying to understand programs. People often rely too much on one way, which is called \&quot;debugging\&quot; and consists of running a partly-understood program to see if it does what you expected. Another way, which ML advocates, is to install some means of understanding in the very programs themselves.&quot;],&quot;author&quot;:&quot;Robin Milner&quot;,&quot;from&quot;:&quot;foreword for &lt;a href=\&quot;http://www.ccs.neu.edu/home/matthias/BTML/\&quot;&gt;The Little MLer&lt;/a&gt;&quot;}]" id="quotes" style="display: none"></div>
    <div id="content">
      <nav class="ui borderless menu desktop" lang="en">
        <div class="ui container">
          <a class="item" href="/"><img src="/static/image/gravatar-black.svg" /></a><a class="item" href="/archive">Archive</a><a class="item" href="/categories">Categories</a><a class="item" href="/tags">Tags</a><a class="item" href="/about">About</a>
          <div class="right menu">
            <div class="item">
              <form action="https://www.google.com/search" class="ui form" method="get" target="_blank">
                <input name="q" type="hidden" value="site:blog2.karottc.com" />
                <div class="ui transparent left icon input">
                  <input name="q" placeholder="Search..." type="text" /><i class="search icon"></i>
                </div>
              </form>
            </div>
            <a class="item" href="https://github.com/karottc"><i class="github icon"></i></a><a class="item" href="/atom.xml"><i class="feed icon"></i></a>
          </div>
        </div>
      </nav>
      <nav class="ui borderless menu mobile" lang="en">
        <div class="ui container">
          <a class="item" href="/"><img src="/static/image/gravatar-black.svg" /></a><a class="item" href="/archive">Archive</a><a class="item" href="/about">About</a>
          <div class="right menu">
            <a class="item" href="https://github.com/karottc/"><i class="github icon"></i></a>
          </div>
        </div>
      </nav><div class="ui stackable container">
  <div class="ui very padded segment article">
    <article class="ui stackable divided grid"><header class="row article-head">
  <div class="column">
    <h1 class="ui header">
      React-Native 播放 FMOD Studio 的 bank 音频
    </h1>
    <div class="ui divider desktop"></div>
  </div>
</header>
<div class="row article-body">
  <section class="twelve wide column"><h2 id="背景">背景</h2>
<p>最近RN的项目中用的音频文件是fmod的.bank 格式的，关于fmod是什么，可以参考<a href="https://www.fmod.com/">fmod的官网</a>（https://www.fmod.com/），或者自己去网上搜索。本项目的核心诉求是，在播放音频的同时，音频会不定时的产生事件回调，通知到RN，然后RN根据事件来绘制不同的页面（展示不同的内容）。</p>
<p>在网上根本找不到任何RN使用fmod的资料，退一步，iOS和Android 使用fmod的资料也是少之又少，都看了一遍之后，毫无帮助，没办法，只能靠自己去尝试了。</p>
<p>从fmod官网下载了iOS、Android、H5的相关库，里面的例子全是C++的，iOS和Android的项目工程文件，根本打不开，官方指导也没有说明第一步、第二步等等分别调用什么API。fmod 以前是做PC上的游戏的，他对移动端的支持非常有限，从文档不全就能略知一二。</p>
<p>本文就梳理一下自己摸索的流程和踩过的坑。</p>
<h2 id="ios">iOS</h2>
<p>首先还是必须去官网下载<a href="https://www.fmod.com/download">fmod的API文档</a>（https://www.fmod.com/download），虽然看了文档也是一脸懵逼，但是聊胜于无，也必须看，因为所有的尝试还是需要依据官方文档来进行。</p>
<p>这个要分成两部分来讲，因为iOS和Android 两个平台，要分别写两套代码，虽然核心使用fmod api的部分是一样的。</p>
<p>对于，iOS的平台，需要提前知道的知识点： * 会react-native（废话，不会这个就不会有这一堆问题了）； * 稍微会一点点Object-c； * 会OC和C++的混编；</p>
<p>基本思路是在RN界面点击播放按钮，然后将音频的相关URL传递给iOS的native函数，下载音频文件，调用FMOD STUDIO API 播放、暂停、停止等操作，同时给播放时注册回调函数，在回调函数中回去数据再回调给RN，然后更新界面。</p>
<p>下面给出关键步骤的部分代码。</p>
<h3 id="react-native-调用ios-native-接口">React-Native 调用iOS Native 接口</h3>
<p>在RN端是通过NativeModules 来实现的</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> <span class="op">{</span>NativeModules<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;react-native&#39;</span><span class="op">;</span>

<span class="co">// OpenNativeModule 这个是iOS端和Android端自己定义和实现的module</span>
<span class="kw">var</span> nativeModule <span class="op">=</span> <span class="va">NativeModules</span>.<span class="at">OpenNativeModule</span><span class="op">;</span>

...

<span class="co">// 调用的时候</span>
<span class="va">nativeModule</span>.<span class="at">testNativeDownloadFile</span>(params)<span class="op">;</span>
<span class="co">// testNativeDownloadFile 是OpenNativeModule中实现的 method</span></code></pre></div>
<p>RN端的核心代码就这几行，剩下的是iOS端的实现。</p>
<div class="sourceCode"><pre class="sourceCode objective-c"><code class="sourceCode objectivec"><span class="co">// 所有能被RN调用的方法，需要用RCT_EXPORT_METHOD声明</span>
RCT_EXPORT_METHOD(testNativeDownloadFile:(NSDictionary *)dict) {
  NSArray *url_list = [dict objectForKey:<span class="st">@&quot;url_list&quot;</span>];
  NSMutableArray __block *file_list = [NSMutableArray arrayWithCapacity:url_list.count];
  NSInteger __block task_count = <span class="dv">0</span>;
  <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; url_list.count; ++i) {
    <span class="co">// 替换url中的空格，否则ios不支持，会有错误码-1002</span>
    NSString *tmpUrl = [url_list[i] stringByReplacingOccurrencesOfString:<span class="st">@&quot; &quot;</span> withString:<span class="st">@&quot;%20&quot;</span>];
    NSURL* url = [NSURL URLWithString:tmpUrl];
    NSLog(<span class="st">@&quot;xxx log: download url: %@&quot;</span>, tmpUrl);
    <span class="co">// 得到session对象</span>
    NSURLSession* session = [NSURLSession sharedSession];
    
    <span class="co">// 创建任务</span>
    
    NSURLSessionDownloadTask* downloadTask = [session downloadTaskWithURL:url completionHandler:^(NSURL *location, NSURLResponse *response, NSError *error) {
      <span class="co">//NSLog(@&quot;xxx log: file path: %@&quot;, location.path);</span>
      <span class="co">// NSLog(@&quot;xxx log: file name: %@&quot;, response.suggestedFilename);</span>
      <span class="co">//NSLog(@&quot;xxx log: error code: %@&quot;, error);   // 如果有异常，输出错误信息</span>
      <span class="co">// [file_list addObject:response.suggestedFilename];</span>
      
      NSString *caches = [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) lastObject];
      <span class="co">// response.suggestedFilename ：建议使用的文件名，一般跟服务器端的文件名一致</span>
      NSString *file = [caches stringByAppendingPathComponent:response.suggestedFilename];
      
      <span class="co">// 将临时文件剪切或者复制Caches文件夹</span>
      NSFileManager *mgr = [NSFileManager defaultManager];
      
      <span class="co">// AtPath : 剪切前的文件路径</span>
      <span class="co">// ToPath : 剪切后的文件路径</span>
      [mgr moveItemAtPath:location.path toPath:file error:nil];
      
      NSLog(<span class="st">@&quot;xxx log: file path:%@&quot;</span>, file);
      
      [file_list addObject:file];
      NSLog(<span class="st">@&quot;xxx log: LINE:%d, file list: %lu&quot;</span>, __LINE__, file_list.count);
      --task_count;  <span class="co">// 任务完成</span>
      }];
    <span class="co">// 开始任务</span>
    ++task_count;
    [downloadTask resume];
    NSLog(<span class="st">@&quot;xxx log: finish&quot;</span>);
    
    <span class="co">//break;</span>
  }
  <span class="kw">while</span> (true) {
    <span class="kw">if</span> (task_count &lt;= <span class="dv">0</span>) {
      NSLog(<span class="st">@&quot;xxx log: LINE:%d, file list: %lu&quot;</span>, __LINE__, file_list.count);
      <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; file_list.count; ++i) {
        NSLog(<span class="st">@&quot;xxx log: LINE:%d, file_name: %@&quot;</span>, __LINE__, file_list[i]);
      }
      <span class="kw">break</span>;
    }
  }</code></pre></div>
<h3 id="播放fmod-studio-的-bank-音频">播放FMOD Studio 的 bank 音频</h3>
<p>由于FMOD官方给的API都是C/C++的，所以这里需要OC和C++混编来实现音频播放，上面的调用Native接口的代码已经把所有的音频文件下载好了，剩下的就是加载相关的库来播放。</p>
<div class="sourceCode"><pre class="sourceCode objective-c"><code class="sourceCode objectivec">
FMOD::Studio::System* gsystem = NULL;
FMOD::Studio::EventDescription * geventDesc = NULL;
FMOD::Studio::EventInstance * gengine = NULL;

<span class="dt">const</span> <span class="dt">int</span> BANK_COUNT = (<span class="dt">int</span>)file_list.count;
  FMOD::Studio::Bank* banks[BANK_COUNT];
  <span class="kw">if</span> (gsystem == NULL) {
    NSLog(<span class="st">@&quot;xxx log: LINE:%d, init fmod studio system&quot;</span>, __LINE__);
    <span class="co">//FMOD::Studio::System::create(&amp;gsystem);</span>
  } <span class="kw">else</span> {
    NSLog(<span class="st">@&quot;xxx log: LINE:%d, unloadAll fmod studio system&quot;</span>, __LINE__);
    <span class="co">//gengine-&gt;stop(FMOD_STUDIO_STOP_IMMEDIATE);</span>
    <span class="co">//gsystem-&gt;unloadAll();</span>
    gsystem-&gt;release();
  }
  FMOD::Studio::System::create(&amp;gsystem);
  gsystem-&gt;initialize(<span class="dv">1024</span>, FMOD_STUDIO_INIT_NORMAL, FMOD_INIT_NORMAL, <span class="dv">0</span>);
  gsystem-&gt;setCallback(studioCallback, FMOD_STUDIO_SYSTEM_CALLBACK_BANK_UNLOAD);
  <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; file_list.count; ++i) {
    gsystem-&gt;loadBankFile([file_list[i] cStringUsingEncoding:NSUTF8StringEncoding], FMOD_STUDIO_LOAD_BANK_NORMAL, &amp;banks[i]);
  }
  gsystem-&gt;update();
  NSString *eventStr = [<span class="st">@&quot;event:/&quot;</span> stringByAppendingString: fmod_name];
  NSLog(<span class="st">@&quot;xxx log: LINE:%d, event_file: %@&quot;</span>, __LINE__, eventStr);
  gsystem-&gt;getEvent([eventStr cStringUsingEncoding:NSUTF8StringEncoding], &amp;geventDesc);
  <span class="co">// 控制延迟的，暂时不用</span>
  <span class="co">//FMOD::System *lowLevelSystem;</span>
  <span class="co">//gsystem-&gt;getLowLevelSystem(&amp;lowLevelSystem);</span>
  <span class="co">//lowLevelSystem-&gt;setDSPBufferSize(4096, 2);</span>
  <span class="co">//gsystem-&gt;getEvent(&quot;event:/xxxxx&quot;, &amp;geventDesc);</span>
  geventDesc-&gt;createInstance(&amp;gengine);
  gengine-&gt;start();
  gsystem-&gt;update();
}


<span class="co">// Callback to free memory-point allocation when it is safe to do so</span>
<span class="co">//</span>
FMOD_RESULT F_CALLBACK studioCallback(FMOD_STUDIO_SYSTEM *system, FMOD_STUDIO_SYSTEM_CALLBACK_TYPE type, <span class="dt">void</span> *commanddata, <span class="dt">void</span> *userdata)
{
  <span class="kw">if</span> (type == FMOD_STUDIO_SYSTEM_CALLBACK_BANK_UNLOAD)
  {
    <span class="co">// For memory-point, it is now safe to free our memory</span>
    FMOD::Studio::Bank* bank = (FMOD::Studio::Bank*)commanddata;
    <span class="dt">void</span>* memory;
    ERRCHECK(bank-&gt;getUserData(&amp;memory));
    <span class="kw">if</span> (memory)
    {
      free(memory);
    }
  }
  <span class="kw">return</span> FMOD_OK;
}</code></pre></div>
<p>现在，已经可以正常播放FMOD的音频了，接下来我们要获取音频播放过程中的事件，这个相对就很简单了，设置一下回调就ok。</p>
<div class="sourceCode"><pre class="sourceCode objective-c"><code class="sourceCode objectivec">gengine-&gt;setCallback(markerCallback,
                       FMOD_STUDIO_EVENT_CALLBACK_TIMELINE_MARKER
                       | FMOD_STUDIO_EVENT_CALLBACK_TIMELINE_BEAT
                       | FMOD_STUDIO_EVENT_CALLBACK_SOUND_PLAYED
                       | FMOD_STUDIO_EVENT_CALLBACK_SOUND_STOPPED);

<span class="co">// marker的回调</span>
FMOD_RESULT F_CALLBACK markerCallback(FMOD_STUDIO_EVENT_CALLBACK_TYPE type, FMOD_STUDIO_EVENTINSTANCE *event, <span class="dt">void</span> *parameters) {
  cout &lt;&lt; <span class="st">&quot;LINE:&quot;</span> &lt;&lt; __LINE__ &lt;&lt; <span class="st">&quot;,xxx log: type:&quot;</span> &lt;&lt; type &lt;&lt; <span class="st">&quot;,obj:&quot;</span> &lt;&lt; FMOD_STUDIO_EVENT_CALLBACK_TIMELINE_MARKER &lt;&lt; endl;
  <span class="kw">if</span> (type == FMOD_STUDIO_EVENT_CALLBACK_TIMELINE_MARKER) {
    FMOD_STUDIO_TIMELINE_MARKER_PROPERTIES* props = (FMOD_STUDIO_TIMELINE_MARKER_PROPERTIES*)parameters;
    <span class="co">///TODO</span>
  }
  ...
  <span class="kw">return</span> FMOD_OK;
}</code></pre></div>
<p>接下来需要把音频的回调传递给RN侧，iOS侧通过一个事件通知来做。</p>
<div class="sourceCode"><pre class="sourceCode objective-c"><code class="sourceCode objectivec"><span class="co">// native 主动通知 rn端</span>
- (instancetype)init {
  <span class="kw">self</span> = [<span class="kw">super</span> init];
  <span class="kw">if</span> (<span class="kw">self</span>) {
    NSNotificationCenter *defaultCenter = [NSNotificationCenter defaultCenter];
    [defaultCenter removeObserver:<span class="kw">self</span>];
    [defaultCenter addObserver:<span class="kw">self</span>
                      selector:<span class="kw">@selector</span>(sendCustomEvent:)
                          name:<span class="st">@&quot;sendCustomEventNotification&quot;</span>
                        object:nil];
  }
  <span class="kw">return</span> <span class="kw">self</span>;
}
- (<span class="dt">void</span>)sendCustomEvent:(NSNotification *)notification {
  NSString *name = notification.object;
  NSLog(<span class="st">@&quot;LINE: %d,xxx log: notification:%@&quot;</span>, __LINE__,name);
  [<span class="kw">self</span> sendEventWithName:<span class="st">@&quot;customEvent&quot;</span> body:name];
}</code></pre></div>
<p>RN侧接收事件，然后进行相应渲染。</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="at">componentDidMount</span>() <span class="op">{</span>
    <span class="kw">let</span> eventEmitter <span class="op">=</span> <span class="kw">new</span> <span class="at">NativeEventEmitter</span>(nativeModule)<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">listener</span> <span class="op">=</span> <span class="va">eventEmitter</span>.<span class="at">addListener</span>(<span class="st">&quot;customEvent&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">listenCallback</span>)<span class="op">;</span>
  <span class="op">}</span>
  <span class="at">listenCallback</span>(item) <span class="op">{</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;native notition:&quot;</span><span class="op">+</span>item)<span class="op">;</span>
  <span class="op">}</span></code></pre></div>
<p>以上，就是在iOS上播放fmod studio 的 bank 音频的整个流程。</p>
<h2 id="android">Android</h2>
<p>同样由于FMOD的API是c/c++的，所以Android端只能用JNI来实现。这里和iOS不同的地方在于，在iOS上，OC和C/C++可以混编，所以可以同时实现，但是Android端的java和C/C++不能混编，只能分开弄，也就是对音频文件的下周再Android做，调用音频播放接口在C/C++这里做。</p>
<p>下载音频文件的代码如下：</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java"><span class="co">// 能够被rn调用的方法使用@ReactMethod声明</span>
<span class="at">@ReactMethod</span>
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">testNativeDownloadFile</span>(ReadableMap map) {
    <span class="co">// 测试文件下载</span>
    <span class="co">//System.out.print(map);</span>
    Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>, map.<span class="fu">getString</span>(<span class="st">&quot;event&quot;</span>));
    ReadableArray urlList = map.<span class="fu">getArray</span>(<span class="st">&quot;url_list&quot;</span>);
    <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; urlList.<span class="fu">size</span>(); ++i) {
        Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;url:&quot;</span>+urlList.<span class="fu">getString</span>(i));
    }
    <span class="co">// /storage/emulated/0</span>
    <span class="bu">String</span> path = <span class="bu">Environment</span>.<span class="fu">getExternalStorageDirectory</span>().<span class="fu">getAbsolutePath</span>();
    Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;path: &quot;</span> + path);
    <span class="bu">String</span> path1 = <span class="bu">Environment</span>.<span class="fu">getDataDirectory</span>().<span class="fu">getPath</span>();
    Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;path1: &quot;</span> + path1);   <span class="co">// /data</span>
    <span class="bu">String</span> path2 = <span class="bu">Environment</span>.<span class="fu">getDownloadCacheDirectory</span>().<span class="fu">getPath</span>();
    Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;path2: &quot;</span> + path2);   <span class="co">// /data/cache</span>
    <span class="bu">String</span> path3 = <span class="bu">Environment</span>.<span class="fu">getExternalStoragePublicDirectory</span>(<span class="bu">Environment</span>.<span class="fu">DIRECTORY_DOWNLOADS</span>).<span class="fu">getPath</span>();
    Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;path3: &quot;</span> + path3);   <span class="co">// /storage/emulated/0/Download</span>
    <span class="bu">String</span> path4 = <span class="bu">Environment</span>.<span class="fu">getExternalStorageDirectory</span>().<span class="fu">toString</span>();
    Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;path4: &quot;</span> + path4);
    <span class="bu">String</span> path5 = mReactContext.<span class="fu">getExternalFilesDir</span>(<span class="kw">null</span>).<span class="fu">toString</span>();
    Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;path5:&quot;</span>+path5);  <span class="co">// /storage/emulated/0/Android/data/com.test_rn_native/files</span>

    <span class="bu">String</span> namePre = map.<span class="fu">getString</span>(<span class="st">&quot;name_pre&quot;</span>);
    <span class="bu">String</span> fmodName = map.<span class="fu">getString</span>(<span class="st">&quot;event&quot;</span>);

    <span class="bu">String</span>[] fileList = <span class="kw">new</span> <span class="bu">String</span>[urlList.<span class="fu">size</span>()];

    <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; urlList.<span class="fu">size</span>(); ++i) {
        <span class="bu">String</span> fileName = <span class="fu">downloadFile</span>(urlList.<span class="fu">getString</span>(i), namePre);
        fileList[i] = fileName;
    }
    <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; fileList.<span class="fu">length</span>; ++i) {
        <span class="bu">File</span> f = <span class="kw">new</span> <span class="bu">File</span>(fileList[i]);
        <span class="kw">if</span> (f.<span class="fu">exists</span>() &amp;&amp; f.<span class="fu">isFile</span>()) {
            Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>, fileList[i] + <span class="st">&quot; size:&quot;</span> + f.<span class="fu">length</span>());
        } <span class="kw">else</span> {
            Log.<span class="fu">d</span>(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;file not exists:&quot;</span> + fileList[i]);
        }
    }
}
<span class="kw">public</span> <span class="bu">String</span> <span class="fu">downloadFile</span>(<span class="bu">String</span> url, <span class="bu">String</span> namePre) {
    Log.<span class="fu">i</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;downloadFile step into，url=&quot;</span> + url);
    <span class="bu">String</span> filePath = <span class="st">&quot;&quot;</span>;
    <span class="kw">try</span> {
        <span class="bu">String</span> downPath = mReactContext.<span class="fu">getExternalFilesDir</span>(<span class="kw">null</span>).<span class="fu">toString</span>() + <span class="st">&quot;/&quot;</span>;
        <span class="dt">long</span> startTime = <span class="bu">System</span>.<span class="fu">currentTimeMillis</span>();
        <span class="bu">String</span> filename = namePre + url.<span class="fu">substring</span>(url.<span class="fu">lastIndexOf</span>(<span class="st">&quot;/&quot;</span>) + <span class="dv">1</span>);
        Log.<span class="fu">i</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;start download&quot;</span>);
        <span class="bu">URL</span> myURL = <span class="kw">new</span> <span class="bu">URL</span>(url);
        <span class="bu">URLConnection</span> conn = myURL.<span class="fu">openConnection</span>();
        conn.<span class="fu">connect</span>();
        <span class="bu">InputStream</span> is = conn.<span class="fu">getInputStream</span>();
        <span class="dt">int</span> fileSize = conn.<span class="fu">getContentLength</span>();<span class="co">//根据响应获取文件大小</span>
        <span class="kw">if</span> (fileSize &lt;= <span class="dv">0</span>) <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span>(<span class="st">&quot;无法获知文件大小 &quot;</span>);
        <span class="kw">if</span> (is == <span class="kw">null</span>) <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span>(<span class="st">&quot;stream is null&quot;</span>);
        <span class="bu">File</span> file1 = <span class="kw">new</span> <span class="bu">File</span>(downPath);
        <span class="kw">if</span> (!file1.<span class="fu">exists</span>()) {
            file1.<span class="fu">mkdirs</span>();
        }
        filePath = downPath + filename;
        <span class="bu">FileOutputStream</span> fos = <span class="kw">new</span> <span class="bu">FileOutputStream</span>(filePath);
        <span class="dt">byte</span> buf[] = <span class="kw">new</span> <span class="dt">byte</span>[<span class="dv">4096</span>];
        <span class="dt">int</span> downLoadFileSize = <span class="dv">0</span>;
        <span class="kw">do</span>{
            <span class="co">//循环读取</span>
            <span class="dt">int</span> numread = is.<span class="fu">read</span>(buf);
            <span class="kw">if</span> (numread == -<span class="dv">1</span>)
            {
                <span class="kw">break</span>;
            }
            fos.<span class="fu">write</span>(buf, <span class="dv">0</span>, numread);
            downLoadFileSize += numread;
            <span class="co">//更新进度条</span>
        } <span class="kw">while</span> (<span class="kw">true</span>);
        Log.<span class="fu">i</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;download success:&quot;</span> + filePath);
        Log.<span class="fu">i</span>(<span class="st">&quot;xxx&quot;</span>,<span class="st">&quot;totalTime=&quot;</span>+ (<span class="bu">System</span>.<span class="fu">currentTimeMillis</span>() - startTime));
    } <span class="kw">catch</span> (<span class="bu">Exception</span> ex) {
        Log.<span class="fu">e</span>(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;error: &quot;</span> + ex.<span class="fu">getMessage</span>(), ex);
    }
    <span class="kw">return</span> filePath;
}</code></pre></div>
<p>然后把下载的文件传递给JNI层，这里有一点要特别注意， JNI 的编译，只能用CMAKE，老的方式是用NDK编译，但是会有各种各样的问题，用cmake编译，一切都会变得简单。</p>
<p>JNI的代码如下：</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="at">static</span> FMOD::Studio::System* gsystem = NULL;
<span class="at">static</span> FMOD::Studio::EventDescription * geventDesc = NULL;
<span class="at">static</span> FMOD::Studio::EventInstance * gengine = NULL;
<span class="at">static</span> <span class="dt">bool</span> gStop = <span class="kw">false</span>;

<span class="co">// 回调使用</span>
JavaVM *gVM = NULL;
jobject gObj;

<span class="co">//</span>
<span class="co">// Callback to free memory-point allocation when it is safe to do so</span>
<span class="co">//</span>
FMOD_RESULT F_CALLBACK studioCallback(FMOD_STUDIO_SYSTEM *system, FMOD_STUDIO_SYSTEM_CALLBACK_TYPE type, <span class="dt">void</span> *commanddata, <span class="dt">void</span> *userdata)
{
    <span class="cf">if</span> (type == FMOD_STUDIO_SYSTEM_CALLBACK_BANK_UNLOAD)
    {
        <span class="co">// For memory-point, it is now safe to free our memory</span>
        FMOD::Studio::Bank* bank = (FMOD::Studio::Bank*)commanddata;
        <span class="dt">void</span>* memory;
        <span class="co">// ERRCHECK(bank-&gt;getUserData(&amp;memory));</span>
        bank-&gt;getUserData(&amp;memory);
        <span class="cf">if</span> (memory)
        {
            free(memory);
        }
    }
    <span class="cf">return</span> FMOD_OK;
}

<span class="co">// marker的回调</span>
FMOD_RESULT F_CALLBACK markerCallback(FMOD_STUDIO_EVENT_CALLBACK_TYPE type, FMOD_STUDIO_EVENTINSTANCE *event, <span class="dt">void</span> *parameters) {
    <span class="co">//cout &lt;&lt; &quot;LINE:&quot; &lt;&lt; __LINE__ &lt;&lt; &quot;,xxx log: type:&quot; &lt;&lt; type &lt;&lt; &quot;,obj:&quot; &lt;&lt; FMOD_STUDIO_EVENT_CALLBACK_TIMELINE_MARKER &lt;&lt; endl;</span>
    <span class="cf">if</span> (type == FMOD_STUDIO_EVENT_CALLBACK_TIMELINE_MARKER) {
        FMOD_STUDIO_TIMELINE_MARKER_PROPERTIES* props = (FMOD_STUDIO_TIMELINE_MARKER_PROPERTIES*)parameters;
         LOGD(<span class="st">&quot;jni params marker: </span><span class="sc">%s</span><span class="st">&quot;</span>,props-&gt;name);
        <span class="co">// [[NSNotificationCenter defaultCenter] postNotificationName:@&quot;sendCustomEventNotification&quot; object:[NSString stringWithUTF8String:props-&gt;name]];</span>
        <span class="co">// 回调java代码</span>
        <span class="co">// 获取方法ID, 通过方法名和签名, 调用静态方法</span>
        <span class="co">// 非静态方法需要创建实例</span>
        JNIEnv *env;
        <span class="dt">int</span> getEnvStat = gVM-&gt;GetEnv((<span class="dt">void</span> **) &amp;env,JNI_VERSION_1_6);
        <span class="cf">if</span> (getEnvStat == JNI_EDETACHED) {
            <span class="co">//如果没有，主动附加到jvm环境中，获取到env</span>
            <span class="cf">if</span> (gVM-&gt;AttachCurrentThread(&amp;env, NULL) != <span class="dv">0</span>) {
                <span class="cf">return</span> FMOD_OK;
            }
        }
        <span class="co">//通过全局变量g_obj 获取到要回调的类</span>
        jclass javaClass = env-&gt;GetObjectClass(gObj);
        <span class="cf">if</span> (javaClass == <span class="dv">0</span>) {
            LOGD(<span class="st">&quot;Unable to find class&quot;</span>);
            gVM-&gt;DetachCurrentThread();
            <span class="cf">return</span> FMOD_OK;
        }
        jmethodID mid = env-&gt;GetMethodID(javaClass, <span class="st">&quot;callMethod&quot;</span>, <span class="st">&quot;(Ljava/lang/String;)V&quot;</span>);
        <span class="cf">if</span> (mid == NULL) {
            LOGD(<span class="st">&quot;Unable to find method:callMethod&quot;</span>);
            <span class="cf">return</span> FMOD_OK;
        }

        env-&gt;CallVoidMethod(gObj, mid, env-&gt;NewStringUTF(props-&gt;name));
    }
    <span class="cf">return</span> FMOD_OK;
}


JNIEXPORT jstring JNICALL Java_com_test_1rn_1native_OpenNativeModule_testParams
  (JNIEnv *env, jobject obj, jobjectArray urlList, jstring fmodName) {
    LOGD(<span class="st">&quot;STEP into native method&quot;</span>);
    jboolean isCopy = <span class="kw">false</span>;
    <span class="at">const</span> <span class="dt">char</span> *str = env-&gt;GetStringUTFChars(fmodName, &amp;isCopy);
    <span class="cf">if</span> (str == NULL) {
        LOGD(<span class="st">&quot;this error&quot;</span>);
        <span class="cf">return</span> NULL;
    }
    LOGD(<span class="st">&quot;fmodName:</span><span class="sc">%s</span><span class="st">&quot;</span>, str);
    string fmodNameStr = str;

    <span class="dt">int</span> len = env-&gt;GetArrayLength(urlList);
    vector&lt;string&gt; fileList;
    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; len; ++i) {
        jstring jstr = (jstring)env-&gt;GetObjectArrayElement(urlList, i);
        string url = env-&gt;GetStringUTFChars(jstr, NULL);
        fileList.push_back(url);
    }

    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; fileList.size(); ++i) {
        LOGD(<span class="st">&quot;file </span><span class="sc">%d</span><span class="st">: </span><span class="sc">%s</span><span class="st">&quot;</span>,i, fileList[i].c_str());
    }

    <span class="co">//FMOD::Studio::System* gsystem;</span>
    <span class="co">//FMOD::Studio::EventDescription * geventDesc;</span>
    <span class="co">//FMOD::Studio::EventInstance * gengine;</span>

    <span class="at">const</span> <span class="dt">int</span> BANK_COUNT = fileList.size();
    FMOD::Studio::Bank* banks[BANK_COUNT];

    <span class="cf">if</span> (gsystem == NULL) {
        LOGD(<span class="st">&quot;init fmod studio&quot;</span>);
    } <span class="cf">else</span> {
        LOGD(<span class="st">&quot;release fmod studio&quot;</span>);
        gsystem-&gt;release();
    }
    FMOD::Studio::System::create(&amp;gsystem);
    gsystem-&gt;initialize(<span class="dv">1024</span>, FMOD_STUDIO_INIT_NORMAL, FMOD_INIT_NORMAL, <span class="dv">0</span>);
    gsystem-&gt;setCallback(studioCallback, FMOD_STUDIO_SYSTEM_CALLBACK_BANK_UNLOAD);
    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; fileList.size(); ++i) {
        gsystem-&gt;loadBankFile(fileList[i].c_str(), FMOD_STUDIO_LOAD_BANK_NORMAL, &amp;banks[i]);
    }
    gsystem-&gt;update();

    string eventStr = <span class="st">&quot;event:/&quot;</span> + fmodNameStr;

    LOGD(<span class="st">&quot;event:</span><span class="sc">%s</span><span class="st">&quot;</span>,eventStr.c_str());

    gsystem-&gt;getEvent(eventStr.c_str(), &amp;geventDesc);
    geventDesc-&gt;createInstance(&amp;gengine);

    gengine-&gt;setCallback(markerCallback,
                         FMOD_STUDIO_EVENT_CALLBACK_TIMELINE_MARKER
                         | FMOD_STUDIO_EVENT_CALLBACK_TIMELINE_BEAT
                         | FMOD_STUDIO_EVENT_CALLBACK_SOUND_PLAYED
                         | FMOD_STUDIO_EVENT_CALLBACK_SOUND_STOPPED);

    env-&gt;GetJavaVM(&amp;gVM);
    gObj = env-&gt;NewGlobalRef(obj);

    gengine-&gt;start();
    gsystem-&gt;update();

    <span class="cf">return</span> env-&gt;NewStringUTF(<span class="st">&quot;success testParams&quot;</span>);
}

JNIEXPORT <span class="dt">void</span> JNICALL Java_com_test_1rn_1native_OpenNativeModule_testFmodPause
        (JNIEnv *env, jobject obj) {
    <span class="cf">if</span> (gsystem == NULL) {
        <span class="cf">return</span>;
    }
    <span class="dt">bool</span> paused = <span class="kw">false</span>;
    <span class="dt">int</span> ret = gengine-&gt;getPaused(&amp;paused);
    LOGD(<span class="st">&quot;pause: </span><span class="sc">%d</span><span class="st">, ret:</span><span class="sc">%d</span><span class="st">&quot;</span>, paused, ret);
    ret = gengine-&gt;setPaused(!paused);
    gsystem-&gt;update();
}

JNIEXPORT <span class="dt">void</span> JNICALL Java_com_test_1rn_1native_OpenNativeModule_testFmodStop
        (JNIEnv *env, jobject obj) {
    <span class="cf">if</span> (gsystem == NULL) {
        <span class="cf">return</span>;
    }
    <span class="cf">if</span> (gStop == <span class="kw">false</span>) {
        gengine-&gt;stop(FMOD_STUDIO_STOP_IMMEDIATE);
        gStop = <span class="kw">true</span>;
    } <span class="cf">else</span> {
        gengine-&gt;start();
        gStop = <span class="kw">false</span>;
    }

    gsystem-&gt;update();
    LOGD(<span class="st">&quot;stop status: </span><span class="sc">%d</span><span class="st">&quot;</span>, gStop);
}</code></pre></div>
<p>需要修改app/build.gradle 文件，才能把fmod相关的.so 打包进apk中。</p>
<pre class="configure"><code>    sourceSets.main {
       jniLibs.srcDirs = [&#39;src/main/jniLibs&#39;]

    }</code></pre>
<p>要解决react-native 和 FMOD之后引起的32-bit和64-bit 的arm结构不兼容问题，也需要修改app/build.gradle.</p>
<pre class="configure"><code>defaultConfig {
    applicationId &quot;com.test_rn_native&quot;
    minSdkVersion 16
    targetSdkVersion 22
    versionCode 1
    versionName &quot;1.0&quot;
    ndk {
        abiFilters &quot;armeabi-v7a&quot;, &quot;x86&quot;
    }

    externalNativeBuild {
        cmake {
            cppFlags &quot;&quot;
            abiFilters &quot;armeabi-v7a&quot;, &quot;x86&quot;
        }
    }
    packagingOptions {
        exclude &quot;lib/arm64-v8a&quot;    // 排除这个文件夹
    }
}</code></pre>
<p>现在，Android端应该也能正常播放fmod studio bank的音频文件了。最后一步，在rn端接受Android的回调。</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="at">componentDidMount</span>() <span class="op">{</span>
    <span class="kw">let</span> eventEmitter <span class="op">=</span> <span class="kw">new</span> <span class="at">NativeEventEmitter</span>(nativeModule)<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">listener</span> <span class="op">=</span> <span class="va">eventEmitter</span>.<span class="at">addListener</span>(<span class="st">&quot;customEvent&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">listenCallback</span>)<span class="op">;</span>
    <span class="va">DeviceEventEmitter</span>.<span class="at">addListener</span>(<span class="st">&#39;customEvent&#39;</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">listenCallback</span>)<span class="op">;</span>
  <span class="op">}</span>
  <span class="at">listenCallback</span>(item) <span class="op">{</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;native notition:&quot;</span><span class="op">+</span>item)<span class="op">;</span>
  <span class="op">}</span></code></pre></div>
<h2 id="尾">尾</h2>
<p>整个项目的demo工程已经放到<a href="https://github.com/karottc/rn-fmod-demo">GitHub</a>，在几乎没有资料的情况下，自己摸索和尝试，记录一下，给后面有需要的朋友一些参考，当然上面并没有列全我这个过程碰到的各种问题。</p>

    <div class="ui divider"></div>
    <div class="ui small one item menu">
      <a class="item" id="show-disqus-comments" onclick="show_disqus_comments()" title="Fuck GFW, disqus.com has been blocked in China.">Show Disqus Comments</a>
    </div>
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </section>
  <aside class="four wide column">
    <div class="ui small header">
      License
    </div>
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img class="cc-license" src="/static/image/cc_byncsa.flat.guokr.svg" /></a>
    <div class="ui small header">
      Committed
    </div>
    <date>2018-11-12</date>
    <div class="ui small header">
      Updated
    </div>
    <date>2018-11-12</date>
    <div class="ui small header">
      Category
    </div>
    <div class="ui list">
      <div class="item">
        <a href="/categories#技术">
          <div class="ui label">
            技术<sup>10</sup>
          </div>
        </a>
      </div>
    </div>
    <div class="ui small header">
      Tags
    </div>
    <div class="ui list">
      <div class="item">
        <a href="/tags#ReactNative">
          <div class="ui label">
            ReactNative<sup>1</sup>
          </div>
        </a>
      </div>
      <div class="item">
        <a href="/tags#FMOD">
          <div class="ui label">
            FMOD<sup>1</sup>
          </div>
        </a>
      </div>
      <div class="item">
        <a href="/tags#iOS">
          <div class="ui label">
            iOS<sup>1</sup>
          </div>
        </a>
      </div>
      <div class="item">
        <a href="/tags#Android">
          <div class="ui label">
            Android<sup>1</sup>
          </div>
        </a>
      </div>
    </div>
    <div class="ui small header">
      Links
    </div>
    <div class="ui small two item menu">
      <a class="item" title="毕业5周年记" href="/posts/2018-07-01-5th-anniversary-of-graduation/">Prev</a><a class="item" title="Archive" href="/archive">Archive</a>
    </div>
  </aside>
</div>
    </article>
  </div>
</div>
    </div>
    <div id="footer">
      <footer class="ui inverted vertical center aligned footer segment desktop">
        <div class="ui container">
          <p>
            Copyright © 2018–2018 by karottc — Powered by Emacs, Git, Pandoc, Ruby and Nanoc.
          </p>
        </div>
      </footer>
      <footer class="ui inverted vertical center aligned footer segment mobile">
        <div class="ui container">
          <p>
            Copyright © 2018–2018 by karottc
          </p>
        </div>
      </footer>
      <script src="/static/dist/semantic-ui/semantic.min.js"></script>
      <script src="/static/javascript/ga.js"></script>
      <script src="/static/javascript/default.js"></script>
    </div>
  </body>
</html>